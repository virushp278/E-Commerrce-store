<!DOCTYPE html>
<html lang="en">

<head>
    <%- include("./partials/head") %>
    <title><%= product.productName %> - Product Page</title>
</head>

<body>
    <%- include("./partials/nav") %>

    <div class="container mt-5 pt-5">
        <!-- Product Info -->
        <div class="card mb-4 shadow-sm p-4">
            <div class="row g-4">
                <div class="col-md-5">
                    <img src="<%= product.ProductImage %>" class="img-fluid rounded" alt="Product Image">
                </div>
                <div class="col-md-7">
                    <h2><%= product.productName %></h2>
                    <p class="text-muted mb-2">Sold by: <%= product.createdBy.businessName %></p>
                    <h4 class="text-primary mb-3 text"><small class="text-reset">Buy at</small> <b class="text-black">₹<%= product.discountPrice %></b></h4>
                    <h6 class="text-primary mb-3 text-muted"><small>M.R.P ₹<%= product.price %></small></h6>
                    <p><%= product.description %></p>

                    <!-- ⭐ Average Rating -->
                    <% if (comments.length > 0) { 
                        let avgRating = comments.reduce((acc, c) => acc + (c.rating || 0), 0) / comments.length;
                    %>
                        <p>
                            Average Rating:
                            <% for(let i=1; i<=5; i++) { %>
                                <span class="<%= i <= Math.round(avgRating) ? 'star-filled' : 'star-empty' %>">★</span>
                            <% } %>
                            (<%= avgRating.toFixed(1) %>/5)
                        </p>
                    <% } %>

                    <!-- BUY SECTION -->
                    <% if (viewMode === "user") { %>
                        <div class="d-flex gap-3 mt-3">
                            <form action="/cart/add/<%= product._id %>" method="POST">
                                <button class="btn btn-success">Add to Cart</button>
                            </form>
                            <form action="/order/buy/<%= product._id %>" method="GET">
                                <button class="btn btn-primary">Buy Now</button>
                            </form>
                        </div>
                    <% } else if (viewMode === "guest") { %>
                        <div class="mt-3">
                            <a href="/user/signin" class="btn btn-primary">Login to Buy</a>
                        </div>
                    <% } else if (viewMode === "merchant-other") { %>
                        <div class="mt-3">
                            <p><b>You are Viewing as  Merchant.</b></p>
                            <a href="/user/signin" class="btn btn-primary">Login as Customer to Buy</a>
                        </div>
                    <% } else if (viewMode === "merchant-owner") { %>
                        <div class="alert alert-info mt-4">
                            <strong>You are viewing your own product.</strong>
                        </div>
                        <div class="mt-3">
                            <a href="/merchant/products/<%= product._id %>/edit" class="btn btn-warning">Edit Product</a>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Comments -->
        <div class="card mb-4 p-4 shadow-sm">
            <h4>Reviews & Comments</h4>
            <hr>
            <% if (comments.length === 0) { %>
                <p class="text-muted">No reviews yet.</p>
            <% } %>

            <% comments.forEach(comment => { %>
                <div class="mb-3 border-bottom pb-2">
                    <p><strong><%= comment.createdBy.name %></strong></p>

                    <!-- ⭐ Show Rating -->
                    <p>
                        <% for(let i=1; i<=5; i++) { %>
                            <span class="<%= i <= comment.rating ? 'star-filled' : 'star-empty' %>">★</span>
                        <% } %>
                        <small class="text-muted">(<%= comment.rating %>/5)</small>
                    </p>

                    <p><%= comment.content %></p>
                    <small class="text-muted">Posted on: <%= new Date(comment.createdAt).toLocaleString() %></small>

                    <% if (comment.reply) { %>
                        <div class="ms-4 mt-2 p-2 bg-light border rounded">
                            <strong><%= product.createdBy.businessName %> (Merchant):</strong>
                            <%= comment.reply %>
                        </div>
                    <% } %>

                    <% if (viewMode === "merchant-owner") { %>
                        <form action="/product/<%= product._id %>/comments/<%= comment._id %>/reply" method="POST" class="mb-2">
                            <input type="text" name="reply" class="form-control form-control-sm" placeholder="Write a reply..." required>
                            <button class="btn btn-sm btn-outline-primary mt-1">Reply</button>
                        </form>
                    <% } %>
                </div>
            <% }); %>

            <!-- ⭐ Comment Form with Rating -->
            <% if (viewMode === "user") { %>
                <form action="/product/<%= product._id %>/comments" method="POST" class="mt-3">
                    <div class="mb-2">
                        <label class="form-label">Your Rating</label>
                        <div class="rating">
                            <% for(let i=5; i>=1; i--) { %>
                                <input type="radio" id="star<%= i %>" name="rating" value="<%= i %>" required />
                                <label for="star<%= i %>">★</label>
                            <% } %>
                        </div>
                    </div>

                    <div class="input-group">
                        <input type="text" name="content" class="form-control" placeholder="Write a comment..." required>
                        <button class="btn btn-outline-secondary" type="submit">Post</button>
                    </div>
                </form>

                <style>
                .rating {
                    display: flex;
                    flex-direction: row-reverse;
                    justify-content: flex-start;
                }
                .rating input {
                    display: none;
                }
                .rating label {
                    font-size: 1.5rem;
                    color: #ccc;
                    cursor: pointer;
                }
                .rating input:checked ~ label,
                .rating label:hover,
                .rating label:hover ~ label {
                    color: #f5b301;
                }
                .star-filled {
                    color: #f5b301;
                }
                .star-empty {
                    color: #ccc;
                }
                </style>
            <% } %>
        </div>

        <!-- Merchant Orders -->
        <% if (viewMode === "merchant-owner") { %>
            <div class="card shadow-sm p-4 mb-5">
                <h4>Orders for this Product</h4>
                <hr>
                <% if (!product.orders || product.orders.length === 0) { %>
                    <p class="text-muted">No orders yet.</p>
                <% } else { %>
                    <ul class="list-group">
                        <% product.orders.forEach(order => { %>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Order #<%= order._id %> - Qty: <%= order.quantity %>
                                <span class="badge bg-success">₹<%= order.totalPrice %></span>
                            </li>
                        <% }) %>
                    </ul>
                <% } %>
            </div>
        <% } %>
    </div>

    <%- include("./partials/script") %>
</body>

</html>
